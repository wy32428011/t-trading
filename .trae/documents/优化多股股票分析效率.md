# 多股股票分析效率优化计划

## 问题分析
通过分析代码库，发现多股分析效率慢的主要原因：

1. **实时数据获取**：当前使用串行方式获取单个股票数据，每次请求间有0.1秒延迟
2. **数据库查询**：每次只查询一个股票的历史数据，产生大量数据库请求
3. **LLM调用**：多角色分析模式需要4次串行LLM调用，耗时较长
4. **线程池配置**：当前配置可能不是最优，且缺少批量处理机制

## 优化方案

### 1. 批量获取实时数据
- 修改`main.py`中的`analyze_multiple_stocks`方法，先批量获取所有股票的实时数据
- 利用`realtime_stock_data.py`中已有的`get_multiple_stocks_data`方法

### 2. 批量查询数据库
- 修改`database.py`，添加批量获取股票历史数据的方法
- 添加批量获取股票基本信息的方法
- 减少数据库连接次数和查询次数

### 3. 优化LLM调用
- 考虑使用异步LLM调用，提高并发处理能力
- 优化提示词，减少上下文长度，提高LLM响应速度
- 评估是否可以减少多角色分析的LLM调用次数

### 4. 优化线程池配置
- 根据系统资源和LLM服务并发能力，调整`max_workers`值
- 考虑使用`ProcessPoolExecutor`替代`ThreadPoolExecutor`，利用多核CPU

### 5. 添加缓存机制
- 缓存股票基本信息和历史数据
- 减少重复查询，提高分析速度

### 6. 使用异步编程
- 将关键IO操作（网络请求、数据库查询）改为异步
- 提高并发处理能力，减少等待时间

## 实施步骤

1. **第一步**：优化实时数据获取，实现批量获取
2. **第二步**：优化数据库查询，实现批量查询
3. **第三步**：优化线程池配置，调整并发策略
4. **第四步**：添加缓存机制
5. **第五步**：评估并优化LLM调用
6. **第六步**：考虑引入异步编程

## 预期效果
- 减少网络请求次数和数据库查询次数
- 提高并发处理能力
- 减少整体分析时间
- 提高系统的可扩展性

## 风险评估
- 需要确保批量处理不会超过API和数据库的并发限制
- 异步编程可能会增加代码复杂度
- 缓存机制需要考虑数据的时效性

通过以上优化，预计可以显著提高多股股票分析的效率，减少分析时间。